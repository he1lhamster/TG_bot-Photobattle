# PhotoBattle Telegram Bot
Телеграм бот использует чистый Telegram bot API и работает в связке с aiohttp приложением, которое держит веб-сервис и обеспечивает доступ к PostgeSQL базе данных.
Бот добавляется в чат, после чего может быть запущен через команду "/start"

## ДОПОЛНИТЕЛЬНО
Бот запускается через docker-compose, билдятся 6 сервисов - само *aiohttp* приложение, которое имеет API для доступа в базу данных; *poller* - скрипт, опрашивающий телеграм на наличие новых обновлений; *sender* - скрипт, получает сообщения от менеджера и отправляет в телеграм, возвращает менеджеру ответ; *manager* - связующий элемент, принимает обновления от поллера, обрабатывает логику игру, обращаясь по АПИ к базе данных через aiohttp приложение, отсылает сообщения в сендер и обрабатывает ответ от телеграма (например чистит лишние инлайн клавиатуры); *db* - постгрес база данных, которая хранится в volume; и *rabbitmq* - брокер сообщений для общения между собой поллера, менеджера и сендера.
![images/img3.png]

## Как пользоваться ботом
Бот предлагает *создать новую игру*, *посмотреть результаты последней игры* в этом чате или же *прочитать правила*.

### Создать новую игру
При попытке создания новой игры бот проверяет на наличие уже существующей игры, при наличии он предлагает либо завершить старую игру, либо продолжить ее.

Если выбрать продолжить - бот проверит статус игры - запущена она или еще нет и предложит соответствующие опции.
После создания игры будет предложено *присоединиться* к игре или *начать*. Бот проверит, есть ли вы в базе игроков, если нет - то он создаст запись в базе данных. При наличии вашей записи в базе данных Бот добавляет вас к текущей игре и случайным образом выбирает одну из ваших фотографий профиля.
**ВАЖНО!**: Бот не сможет вас зарегистрировать и вернет ошибку при попытке присоединиться к игре, если у вас нет фото в профиле или они закрыты настройками приватности телеграма
При наличии хотя бы двух игроков станет доступна опция начать игру, подробнее в разделе [[Ход игры]].
После каждого раунда можно или продолжить игру, или досрочно завершить ее, без объявления победителя.

### Посмотреть результаты последней игры
Бот выдаст статистику по последней игре, если она была - всех игроков и победителя, если таковой был.
![images/img4.png]

### Правила игры
Правила очень простые. Каждый раунд вам будет предложено несколько пар аватарок.В каждой паре необходимо проголосовать за одну из них в течение отведенного времени, руководствуясь своим субъективным мнением, конечно же.
Победитель, набравший большее количество голосов проходит в следующий раунд. Итак до тех пор, пока не определится победитель.

### Ход игры
Бот сосчитает активных игроков, если их количество не равно 2,4,8 или 16 (максимальное число игроков) то бот добавит "пустышек" в виде котиков до необходимого количества. Далее выбирается случайная пара, при наличии пустышек они всегда выбирается первыми и автоматически проигрывают - их соперник переходит в следующий тур.

Если пара состоит из двух активных игроков, то начинается фотоБаттл - бот высылает выбранные ранее фото из профиля игроков и кнопки для голосования, после чего отсчитывает заданное время - 10 секунд. В это время блокируется любая активность в данном чате, кроме кнопок для голосования.  По истечение заданного времени бот считает голоса, при равенстве победитель выбирается случайно - он переходит в следующий тур.
![images/img1.png]

## Особенности реализации
- Кнопки *начать*, *продолжить*, *завершить* игру, а также *голосовать* доступны каждому участнику чата, даже не участвующему в игре. Если действие возможно совершить, то бот обработает нажатие. Иначе выдаст ошибку, например нельзя присоединиться к игре, которая еще не создана, также как и закончить ее.
- Проголосовать можно только один раз, бот ведет учет проголосовавших.
- Счетчик голосов реализован через одну переменную, каждый голос за участника с левой стороны дает -1, с правой +1. При нулевом значении счетчика победитель определяется случайно.
- Информация в БД хранится в 3х таблицах - games, players and gamescores (many-to-many). В таблице gamescores одна запись - это один игрок в одной игре. У него есть значение статус (0-выбыл, 1-в игре) и номер раунда, в котором он участвует. Бот берет эти цифры из БД и на их основе продолжает игру или объявляет победителя - единственный игрок со статусом = 1, с максимальным номером раунда.
- Для реализации "пустышек", дополняющих количество участников, используются возможности Телеграмма доставать изображения по url. Используется сайт, генерирующий пикчи с котиками "https://cataas.com/cat/".
- В приложении две постоянные очереди - одна передает сообщения поллера в виде обновлений (Update) в бот-менеджер, вторая отдает сообщения из бот-менеджера в сэндер в виде различных сообщений (Message).
- Для реализации одновременной поддержки активных игровых сессий в разных чатах бот обрабатывает все игровые взаимодействия асинхронно, создавая отдельного воркера для каждого коллбэка.
- Присутствует админка API, она позволяет получить список всех игр, а также удалить какого-либо пользователя по id. Админ создается из конфиг файла в момент инциализации приложения.

### Архитектура проекта
![images/img2.png]